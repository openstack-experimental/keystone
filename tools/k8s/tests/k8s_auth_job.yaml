apiVersion: batch/v1
kind: Job
metadata:
  name: "keystone-k8s-auth-test-job"
spec:
  backoffLimit: 1
  template:
    spec:
      serviceAccountName: keystone-k8s-auth-test-sa
      initContainers:
        - name: verify-token
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              # 1. Define paths and variables
              KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
              KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              APISERVER=https://kubernetes.default.svc
              
              echo "Attempting to verify token via TokenReview API..."

              # 2. Perform the TokenReview call
              # We send a JSON body containing the token to be reviewed
              curl -sS --cacert $KUBE_CA \
                -X POST \
                -H "Authorization: Bearer $KUBE_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{
                  \"apiVersion\": \"authentication.k8s.io/v1\",
                  \"kind\": \"TokenReview\",
                  \"spec\": {
                    \"token\": \"$KUBE_TOKEN\"
                  }
                }" \
                $APISERVER/apis/authentication.k8s.io/v1/tokenreviews

      containers:
        - name: test
          image: keystone-tests
          command: ["/tests/test-k8s-auth"]
      restartPolicy: "Never"
